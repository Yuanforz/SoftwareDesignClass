# 桌宠模式修复说明

## 📝 修复内容

### 1. **移除 iframe 方案**
- **问题**: 之前使用 iframe 嵌入整个原前端(`http://127.0.0.1:12393`),导致原UI和对话框也显示出来
- **解决**: 完全移除iframe,改用简单的占位符显示Live2D区域
- **文件**: `desktop_pet.js` 的 `initLive2D()` 函数

### 2. **简化 Live2D 显示**
- 使用纯占位符HTML元素(🎭图标 + "灵犀助教"文字)
- 移除所有iframe相关代码
- 移除CSS中的 `#live2d-iframe` 样式规则

### 3. **保持自己的前端代码**
- **HTML**: `desktop_pet.html` - 独立的桌宠界面
- **CSS**: `desktop_pet.css` - 完整样式(包括漫画气泡、透明背景等)
- **JavaScript**: `desktop_pet.js` - WebSocket通信、消息处理、渲染逻辑

## 🔍 后端问题诊断

根据用户提供的后端日志:

```
# 第一次(使用新对话框) - 没有完整响应
2026-01-11 13:06:17 | INFO | New Conversation Chain 🌹 started!
2026-01-11 13:06:17 | INFO | User input: 你好
2026-01-11 13:06:17 | INFO | Starting simple chat completion.

# 第二次(使用原对话框) - 正常响应
2026-01-11 13:06:41 | INFO | New Conversation Chain 🌍 started!
2026-01-11 13:06:41 | INFO | User input: 你好
2026-01-11 13:06:41 | INFO | Starting simple chat completion.
INFO: 127.0.0.1:5178 - "GET /avatars/mao.png HTTP/1.1" 200 OK
```

**分析**:
1. 两次都正确接收到 "User input: 你好"
2. 两次都启动了 "Starting simple chat completion"
3. 第一次(新对话框)之后没有进一步日志
4. 第二次(原对话框)有 avatar 请求(说明前端收到响应并渲染了)

**可能原因**:
1. ✅ WebSocket 消息格式正确(都能收到 "User input")
2. ❓ LLM 响应可能被发送了,但前端没有正确接收/处理
3. ❓ 可能是 WebSocket 连接问题(不同的 client_uid?)

## 🧪 测试步骤

### 1. 启动后端
```powershell
cd D:\Desktop\SoftwareDesign\Open-LLM-VTuber-v1.2.1-zh
uv run run_server.py
```

### 2. 启动桌宠前端
```powershell
cd D:\Desktop\SoftwareDesign\Open-LLM-VTuber-v1.2.1-zh\desktop_launcher
npm start
```

### 3. 打开开发者工具
- 启动后按 `F12` 或 `Ctrl+Shift+I`
- 切换到 **Console** 标签

### 4. 测试消息发送
1. 输入 "你好" 并按 Enter
2. 观察 Console 输出:
   - 应该看到 `📤 准备发送消息: 你好`
   - 应该看到 `📤 发送消息对象: {type: 'text-input', text: '你好', images: []}`
   - 应该看到 `📩 收到消息: ...`(后端响应)

3. 观察后端终端:
   - 应该看到 "User input: 你好"
   - 应该看到 LLM 的响应生成过程

### 5. 检查 WebSocket 连接
在 Console 中输入:
```javascript
AppState.ws.readyState
```
- 返回 `1` = OPEN(正常)
- 返回 `0` = CONNECTING
- 返回 `2` = CLOSING
- 返回 `3` = CLOSED

### 6. 检查收到的消息
在 Console 中输入:
```javascript
// 查看最近收到的消息
console.log(AppState)
```

## 🐛 可能遇到的问题

### 问题 1: Live2D 区域空白
- **正常**: 现在只显示占位符(🎭 + "灵犀助教")
- **原因**: 我们移除了iframe,不再加载原前端的Live2D
- **临时方案**: 占位符已经足够用于课设演示

### 问题 2: 发送消息后没有响应
- **检查 Console**: 是否有 `📩 收到消息` 日志?
- **检查后端**: 是否有 "llm-output" 或 "full-text" 类型的消息发送?
- **调试**: 在 `handleWebSocketMessage()` 函数开头添加 `debugger;` 断点

### 问题 3: WebSocket 连接失败
- **症状**: Console 显示 "❌ WebSocket 连接失败"
- **解决**: 确保后端运行在 `http://127.0.0.1:12393`
- **检查**: 浏览器访问 `http://127.0.0.1:12393` 应该能看到原前端

## 📋 下一步调试

如果消息发送后仍然没有响应,请提供:

1. **前端 Console 的完整日志**(从启动到发送消息)
2. **后端完整日志**(包括 LLM 响应生成的部分)
3. **Network 标签中的 WebSocket 消息**:
   - 打开 DevTools → Network 标签
   - 筛选 `WS`(WebSocket)
   - 点击 `client-ws` 连接
   - 查看 Messages 标签

## 🎯 代码变更总结

### 修改的文件
1. `desktop_launcher/desktop_pet.js`:
   - `initLive2D()` 函数简化为占位符方案
   - 移除所有iframe相关代码

2. `desktop_launcher/desktop_pet.css`:
   - 移除 `#live2d-iframe` 样式规则

### 未修改的文件
- `desktop_launcher/desktop_pet.html` (保持原样)
- `desktop_launcher/main.js` (保持原样)
- `desktop_launcher/package.json` (保持原样,包含UTF-8修复)

## ✅ 预期行为

1. **启动后**:
   - 窗口透明,只显示左侧Live2D区域(占位符)和右侧对话区域
   - Console 显示 "✅ WebSocket 连接成功"
   - 显示欢迎消息 "Connection established"

2. **输入消息后**:
   - 立即显示用户消息(绿色气泡)
   - 等待几秒后显示AI回复(白色气泡,带左箭头)
   - 回复内容支持 Markdown 和 LaTeX 渲染

3. **右键菜单**:
   - 右键点击 Live2D 区域显示圆形菜单
   - 可以清空历史、查看历史、设置等

---

**修复时间**: 2026-01-11 13:15  
**修复者**: GitHub Copilot  
**版本**: Open-LLM-VTuber v1.2.1-zh 桌宠模式 v1.0
