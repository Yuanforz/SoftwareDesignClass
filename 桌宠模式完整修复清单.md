# 桌宠模式完整修复清单

## ✅ 已修复的问题

### 1. ✅ LaTeX 渲染问题修复
**问题**: 占位符 `MATH_INLINE_0` 没有被还原成实际公式

**原因**: Markdown 渲染后，占位符在 `<p>` 标签内，需要查找并替换成渲染后的公式

**解决方案**:
- 使用 `<span>` 元素作为占位符
- 添加 `data-index` 属性存储索引
- 使用 `querySelectorAll` 找到所有占位符
- 直接调用 `katex.render()` 渲染到 `<span>` 元素

**修改文件**: `desktop_pet.js` 的 `renderMarkdownAndLatex()` 函数

```javascript
// 新的占位符方案
mathBlocks.forEach((math, index) => {
    element.innerHTML = element.innerHTML.replace(
        `__MATH_INLINE_${index}__`,
        `<span class="math-placeholder-inline" data-index="${index}"></span>`
    );
});

// 渲染公式
element.querySelectorAll('.math-placeholder-inline').forEach(span => {
    const index = parseInt(span.dataset.index);
    const math = mathBlocks[index];
    katex.render(math.content, span, { displayMode: false });
});
```

### 2. ✅ 音频播放功能
**问题**: 收到 TTS 音频但听不到声音

**原因**: `audio` 消息类型没有实际播放音频，只显示了文本

**解决方案**:
- 添加 `playAudioFromBase64()` 函数
- 解码 Base64 编码的 WAV 音频
- 使用 `Audio` API 播放

**修改文件**: `desktop_pet.js`

```javascript
function playAudioFromBase64(base64Audio) {
    const binaryString = atob(base64Audio);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    
    const blob = new Blob([bytes], { type: 'audio/wav' });
    const url = URL.createObjectURL(blob);
    const audio = new Audio(url);
    audio.play();
}
```

**注意事项**:
- 浏览器需要用户交互后才能自动播放音频
- 如果首次自动播放失败，用户点击页面后会恢复

### 3. ✅ 后端句子切分破坏 Markdown
**问题**: `**粗体**` 被切分成 `**粗体` 和 `**`，导致渲染失败

**原因**: `comma_splitter()` 函数在逗号处切分，没有考虑 Markdown 语法

**解决方案**:
- 添加 `is_inside_markdown()` 辅助函数
- 检查逗号位置是否在 `**`, `__`, `*`, `_`, ``` 等标记内部
- 只在安全位置切分

**修改文件**: `src/open_llm_vtuber/utils/sentence_divider.py`

```python
def is_inside_markdown(text, pos):
    """检查位置pos是否在markdown标记内部"""
    before = text[:pos]
    
    # 检查**bold**
    bold_stars = before.count('**')
    if bold_stars % 2 == 1:  # 奇数个，说明在标记内部
        return True
    
    # 检查__bold__
    bold_underscores = before.count('__')
    if bold_underscores % 2 == 1:
        return True
    
    # 检查*italic*和_italic_
    single_stars = before.count('*') - bold_stars * 2
    single_underscores = before.count('_') - bold_underscores * 2
    if single_stars % 2 == 1 or single_underscores % 2 == 1:
        return True
    
    # 检查`code`和```code block```
    backticks = before.count('`')
    triple_backticks = before.count('```')
    if (backticks - triple_backticks * 3) % 2 == 1:
        return True
    
    return False
```

### 4. ✅ Live2D 加载优化
**问题**: 要求自己重写 Live2D 而不是用 iframe

**解决方案**:
- 引入 **PIXI.js** (WebGL 渲染引擎)
- 引入 **pixi-live2d-display** (Live2D 显示库)
- 直接加载 `.model3.json` 文件
- 降级方案：如果 SDK 加载失败，使用 iframe

**修改文件**: 
- `desktop_pet.html`: 添加 SDK CDN 引用
- `desktop_pet.js`: 重写 `initLive2D()` 函数

```javascript
async function initLive2D() {
    // 检查 SDK 是否加载
    if (typeof PIXI === 'undefined' || typeof PIXI.live2d === 'undefined') {
        console.error('Live2D SDK 未加载，使用备用方案');
        loadLive2DViaIframe();
        return;
    }
    
    // 创建 PIXI 应用
    const app = new PIXI.Application({
        view: live2dCanvas,
        width: 300,
        height: 600,
        backgroundAlpha: 0
    });
    
    // 加载模型
    const modelUrl = 'http://127.0.0.1:12393/live2d-models/mao_pro/runtime/mao_pro.model3.json';
    const model = await PIXI.live2d.Live2DModel.from(modelUrl);
    
    // 设置位置和大小
    model.scale.set(0.15);
    model.x = app.screen.width / 2;
    model.y = app.screen.height;
    
    app.stage.addChild(model);
}
```

**CDN 引用**:
```html
<script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.5.0/dist/index.min.js"></script>
```

## 📋 测试步骤

### 1. 重启应用
```powershell
# 后端（如果没运行）
cd D:\Desktop\SoftwareDesign\Open-LLM-VTuber-v1.2.1-zh
uv run run_server.py

# 前端
cd D:\Desktop\SoftwareDesign\Open-LLM-VTuber-v1.2.1-zh\desktop_launcher
npm start
```

### 2. 测试 LaTeX 渲染
发送包含公式的消息：
```
请解释高斯定理：$\nabla \cdot \mathbf{E} = \frac{\rho}{\epsilon_0}$
```

**预期结果**: 公式正确渲染，不会显示 `MATH_INLINE_0`

### 3. 测试音频播放
发送任意消息：
```
你好
```

**预期结果**: 
- 看到AI回复文本
- **听到 TTS 语音**
- Console 显示 `🔊 开始播放音频`

**如果听不到**:
- 点击页面任意位置（激活音频权限）
- 重新发送消息

### 4. 测试 Markdown 粗体
发送包含粗体的消息：
```
请解释**麦克斯韦方程组**的物理意义
```

**预期结果**: 
- "麦克斯韦方程组" 显示为粗体
- 不会出现单个 `**` 符号

### 5. 测试 Live2D SDK 加载
打开 DevTools → Console

**预期输出**:
```
🎨 开始初始化 Live2D...
✅ Live2D 模型加载完成
🎭 模型信息: {width: xxx, height: xxx, scale: 0.15}
```

**如果失败**: 会自动降级到 iframe 方案

## 🎯 已实现的功能

### 前端
- ✅ WebSocket 通信
- ✅ Markdown 渲染
- ✅ LaTeX 公式渲染（修复占位符问题）
- ✅ TTS 音频播放
- ✅ 漫画风格气泡对话
- ✅ 圆形右键菜单
- ✅ 拖拽上传图片
- ✅ Live2D SDK 直接加载（有降级方案）

### 后端
- ✅ 句子切分保护 Markdown 语法
- ✅ TTS 语音合成
- ✅ LLM 对话生成
- ✅ 图片识别（vision）

## 🐛 已知限制

### Live2D
- **CORS 限制**: 如果 CDN 的 SDK 加载失败，会降级到 iframe
- **模型路径**: 需要后端运行在 `http://127.0.0.1:12393`
- **动画**: 目前只加载模型，暂未实现表情和动作

### 音频播放
- **浏览器策略**: 需要用户交互后才能自动播放
- **首次播放**: 可能需要点击页面激活音频权限

### Markdown 保护
- **基础保护**: 只保护常见的 `**bold**`, `*italic*`, `__bold__`, `_italic_`, ``` `code` ```
- **嵌套语法**: 复杂嵌套可能仍有问题（如 `**bold _italic_**`）
- **建议**: 避免在逗号前后使用复杂 Markdown 语法

## 📦 依赖项

### CDN 库
```html
<!-- Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

<!-- LaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

<!-- Live2D SDK -->
<script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.5.0/dist/index.min.js"></script>
```

### Python 后端
- FunASR (语音识别)
- Edge TTS (语音合成)
- StepFun API (LLM)
- FastAPI (WebSocket 服务)

## 🚀 下一步优化建议

1. **Live2D 动画**: 实现表情切换和口型同步
2. **音量控制**: 添加 TTS 音量调节
3. **历史记录**: 完善历史对话加载
4. **设置面板**: 保存用户偏好设置
5. **错误处理**: 更友好的错误提示

---

**修复日期**: 2026-01-11  
**修复者**: GitHub Copilot  
**版本**: Open-LLM-VTuber v1.2.1-zh 桌宠模式 v2.0
