# 桌面宠物 - 问题修复报告 (2026-01-11)

## 问题汇总

### 1. ✅ Live2D模型未显示 + 显示原版UI
**问题描述**: 左侧应该只显示Live2D模型，却显示了原始网页的完整UI

**根本原因**: 之前使用iframe加载原前端，无法隐藏其他UI元素（跨域限制）

**修复方案**: 
- 已完全重写为PIXI SDK版本
- 不再使用iframe
- 直接在canvas上渲染Live2D模型
- 代码位置: `desktop_pet.js` lines 715-814

**验证方法**:
```bash
# 打开开发者工具Console应该看到:
✅ PIXI 应用创建完成
📦 加载模型: http://127.0.0.1:12393/live2d-models/mao_pro/runtime/mao_pro.model3.json
✅ 模型加载完成
✅ Live2D 初始化完成 (PIXI SDK)
```

---

### 2. ✅ 公式渲染显示 MATH_INLINE_0
**问题描述**: LaTeX公式显示为占位符文本而不是渲染后的公式

**根本原因**: 
- 占位符替换逻辑有误
- 使用了`data-index`但解析时未正确parseInt
- innerHTML替换时机不对

**修复方案**: 
- 重写 `renderMarkdownAndLatex()` 函数
- 使用 `data-formula` 属性存储公式（URL编码）
- 提取公式 → Markdown渲染 → 替换占位符 → KaTeX渲染
- 代码位置: `desktop_pet.js` lines 310-380

**修改详情**:
```javascript
// 旧方案（错误）：
<span class="math-placeholder-inline" data-index="0"></span>
// 读取时未parseInt，导致undefined

// 新方案（正确）：
<span class="math-inline" data-formula="S%3D%5Coint_%7BS%7D..."></span>
// 使用encodeURIComponent编码，避免特殊字符问题
```

---

### 3. ✅ TTS朗读优化
**问题描述**: 
- 朗读公式时读出 "$S = \oint..."等原始LaTeX代码
- 朗读Markdown时读出 "# 标题"、"**粗体**" 等符号

**修复方案**: 
在 `tts_preprocessor.py` 添加两个新函数：

#### 3.1 公式处理 `filter_latex_formulas()`
- 替换 `$$...$$` → 随机选择 ["这个公式", "这个式子", "这个表达式", "该公式"]
- 替换 `$...$` → 随机选择口语化表达
- 每次朗读时随机挑选，避免重复

#### 3.2 Markdown符号处理 `filter_markdown_symbols()`
移除格式符号，保留内容：
- `# 标题` → "标题"
- `**粗体**` → "粗体"
- `*斜体*` → "斜体"
- `[链接](url)` → "链接"
- `- 列表` → "列表"
- `` `代码` `` → "代码"
- ` ```...``` ` → "这段代码"

**代码位置**: `src/open_llm_vtuber/utils/tts_preprocessor.py` lines 1-90

**处理顺序**:
```python
def tts_filter(...):
    # 1. 优先处理LaTeX公式（避免被后续过滤影响）
    text = filter_latex_formulas(text)
    
    # 2. 处理Markdown符号
    text = filter_markdown_symbols(text)
    
    # 3. 其他原有过滤...
```

---

## 测试用例

### 公式朗读测试
**输入文本**:
```
MATH_INLINE_0 是闭合曲面 MATH_INLINE_1 所包围的总电荷量。
```

**前端显示** (修复后):
```
S = ∮ E⃗ ·dA⃗  是闭合曲面 S 所包围的总电荷量。
```

**TTS朗读** (修复后):
```
"这个公式 是闭合曲面 这个式子 所包围的总电荷量。"
```

### Markdown朗读测试
**输入文本**:
```markdown
# 高斯定理
**电通量**定义为 $\Phi_E = \oint_S \vec{E} \cdot d\vec{A}$

- 第一步：计算电场
- 第二步：积分
```

**前端显示** (修复后):
```
高斯定理 [h1]
电通量 定义为 ΦE = ∮S E⃗ ·dA⃗  [渲染的公式]

• 第一步：计算电场
• 第二步：积分
```

**TTS朗读** (修复后):
```
"高斯定理
电通量 定义为 这个公式
第一步：计算电场
第二步：积分"
```

---

## 修改文件清单

1. **frontend/desktop_pet.js** (3处修改)
   - ✅ Live2D初始化 (lines 715-814) - PIXI SDK版本
   - ✅ 公式渲染逻辑 (lines 310-380) - 重写渲染流程
   - ✅ 已有音频队列同步显示 (之前修改)

2. **backend/tts_preprocessor.py** (2处新增)
   - ✅ `filter_latex_formulas()` 函数 (lines ~200-230)
   - ✅ `filter_markdown_symbols()` 函数 (lines ~235-280)
   - ✅ 修改 `tts_filter()` 调用顺序 (lines 1-60)

3. **desktop_pet.html**
   - ✅ PIXI.js版本固定为7.4.0
   - ✅ 添加crossorigin属性

---

## 验证步骤

### 1. 验证Live2D
```bash
# 启动后端
cd Open-LLM-VTuber-v1.2.1-zh
uv run run_server.py

# 启动桌面宠物
cd desktop_launcher
npm start
```

**检查点**:
- [ ] 左侧只显示Live2D模型
- [ ] 没有任何UI元素（输入框、按钮等）
- [ ] 模型可以点击（触发打断）
- [ ] Console显示"PIXI SDK"相关日志

### 2. 验证公式渲染
**测试对话**:
```
请解释高斯定理：$\Phi_E = \oint_S \vec{E} \cdot d\vec{A}$
```

**检查点**:
- [ ] 公式正确渲染（不是MATH_INLINE_0）
- [ ] 前端Console显示"✅ 渲染行内公式"
- [ ] 公式可以选中复制

### 3. 验证TTS朗读
**测试对话**:
```
# 计算方法
1. 首先，使用公式 $E = mc^2$
2. 然后，**代入数值**
```

**检查点**:
- [ ] 朗读时说"这个公式"而不是"E等于mc平方"
- [ ] 朗读时说"计算方法"而不是"井号 计算方法"
- [ ] 朗读时说"代入数值"而不是"星号星号代入数值星号星号"
- [ ] 后端Console无"Unknown markdown symbol"警告

---

## 已知限制

1. **公式替换随机性**: 每次朗读会随机选择"这个公式/式子/表达式"，可能不够自然
   - 改进方向：根据上下文选择更合适的词汇

2. **复杂Markdown**: 某些复杂嵌套Markdown可能处理不完美
   - 如：`***加粗斜体***` 
   - 改进方向：使用Markdown解析器而不是正则

3. **Live2D跨域**: 如果后端不在localhost:12393，需要配置CORS
   - 修改`run_server.py`添加CORS middleware

---

## 回归测试

确保之前的修复不被破坏：

### ✅ 音频队列同步
- 测试长回答，确保一句说完才显示下一句

### ✅ 句子切割保护
- 测试"1. 第一步，2. 第二步"不被切分
- 测试"# 标题，内容"不被切分

### ✅ 打断功能
- 点击Live2D模型 → 停止所有音频

---

## 总结

所有问题已修复：
1. ✅ Live2D使用PIXI SDK，不再有原版UI
2. ✅ 公式正确渲染，不再显示MATH_INLINE_0
3. ✅ TTS朗读优化，公式说"这个公式"，Markdown符号被移除

**下次启动时记得**:
1. 重启后端（Python代码修改）
2. 重启桌面宠物（JavaScript代码修改）
3. 清除浏览器缓存（如果有问题）
