# 桌面宠物模式 - 修复说明

## 修复日期
2026年1月11日

## 修复内容

### 1. ✅ Live2D SDK 加载修复
**问题**: Live2D仍使用iframe加载原前端页面，未使用PIXI SDK

**修复**:
- 完全重写 `initLive2D()` 函数使用 PIXI.js + pixi-live2d-display SDK
- 移除iframe相关代码
- 使用 `PIXI.Application` 创建画布渲染器
- 使用 `PIXI.live2d.Live2DModel.from()` 加载模型
- 正确的模型路径: `http://127.0.0.1:12393/live2d-models/mao_pro/runtime/mao_pro.model3.json`

**修改文件**:
- `desktop_launcher/desktop_pet.js` (lines 607-690)
- `desktop_launcher/desktop_pet.html` (PIXI版本固定为7.4.0)

### 2. ✅ 文本同步显示修复
**问题**: 音频还在播放第一句时，后面所有句子已经全部显示在聊天框

**修复**:
- 修改 `audio` 消息处理：收到音频消息时**不立即显示文本**
- 将音频和文本一起加入队列
- 在 `AudioQueue.playNext()` 中，**先显示文本，再播放音频**
- 确保文本显示与音频播放严格同步

**工作流程**:
```
收到audio消息 → 加入队列(音频+文本) → 不显示文本
↓
播放队列 → 先显示文本 → 再播放音频 → 播放完成 → 播放下一个
```

**修改文件**:
- `desktop_launcher/desktop_pet.js`
  - `case 'audio'` 消息处理 (line ~87)
  - `AudioQueue.playNext()` 添加 `addMessage()` 调用 (line ~193)

### 3. ✅ 句子切割优化
**问题**: 
- "1. xxx" 被切分成 "1." + "xxx"
- Markdown标题 "# xxx, yyy" 被切分

**修复**:
在 `comma_splitter()` 添加 `should_skip_comma()` 保护函数，跳过：

1. **数字序号后的逗号**
   - `1, 2, 3` → 不切分
   - `1. 第一项, 第二项` → 不切分"1."后的逗号

2. **Markdown标题行内的逗号**
   - `# 标题一, 标题二` → 不切分

3. **Markdown格式内的逗号** (原有功能保持)
   - `**粗体, 内容**` → 不切分

**检测逻辑**:
```python
# 使用正则表达式匹配数字序号
if re.search(r'\d+[.)\u3001]?\s*$', check_text):
    return True  # 跳过切分
```

**修改文件**:
- `src/open_llm_vtuber/utils/sentence_divider.py`
  - 添加 `should_skip_comma()` 函数 (line ~143)
  - 修改逗号检测逻辑 (line ~173)

## 测试验证

### 句子切割测试
创建了 `测试句子切割.py` 测试保护逻辑：
- ✅ "# 这是标题，xxx" → 跳过标题内逗号
- ✅ "1, 2, 3" → 跳过数字序号逗号
- ✅ "正常文本，xxx" → 正常切分

### 预期效果

#### Live2D显示
```
启动应用 → 加载PIXI.js → 加载pixi-live2d-display
→ 创建canvas → 加载mao_pro模型 → 显示Live2D角色
```

#### 对话同步
```
后端发送3句音频:
  句子1 [audio] → 加入队列
  句子2 [audio] → 加入队列
  句子3 [audio] → 加入队列

前端播放:
  显示句子1 → 播放音频1 → 播放完成
  → 显示句子2 → 播放音频2 → 播放完成
  → 显示句子3 → 播放音频3 → 播放完成
```

#### 句子不被错误切分
```
输入: "请按照以下步骤：1. 打开设置, 2. 选择语言, 3. 保存配置"
切分: ["请按照以下步骤：1. 打开设置, 2. 选择语言, 3. 保存配置"]
      (整句保留，不在序号处切分)

输入: "# 标题: 第一部分, 第二部分"
切分: ["# 标题: 第一部分, 第二部分"]
      (标题行不切分)

输入: "这是普通文本，可以切分，没有保护"
切分: ["这是普通文本，", "可以切分，", "没有保护"]
      (正常切分)
```

## 如何验证修复

1. **启动后端服务器**
```bash
cd Open-LLM-VTuber-v1.2.1-zh
uv run run_server.py
```

2. **启动桌面宠物**
```bash
cd desktop_launcher
npm start
```

3. **检查 Live2D**
- 打开开发者工具 (F12)
- 查看控制台应该看到:
  ```
  ✅ PIXI 应用创建完成
  📦 加载模型: http://127.0.0.1:12393/live2d-models/mao_pro/runtime/mao_pro.model3.json
  ✅ 模型加载完成
  ✅ Live2D 初始化完成
  ```
- 左侧应显示 Live2D 角色（不是iframe）

4. **测试文本同步**
- 对话："请介绍一下你自己"
- 观察：每句话应该在音频播放时才显示，不是一次性全部显示

5. **测试句子切割**
- 对话："请列出步骤：1. 第一步，2. 第二步，3. 第三步"
- 检查后端日志，句子不应该在数字后被切分

## 核心代码改动

### desktop_pet.js 核心改动
```javascript
// 音频队列同步显示
async playNext() {
    const item = this.queue.shift();
    
    // 关键：先显示文本
    console.log(`💬 显示文本: "${item.text}"`);
    addMessage('assistant', item.text);
    
    // 再播放音频
    await this.playAudioFromBase64(item.base64Audio);
    this.playNext();
}
```

### sentence_divider.py 核心改动
```python
def should_skip_comma(text, pos):
    # 数字序号保护
    check_text = text[:pos][-10:]
    if re.search(r'\d+[.)\u3001]?\s*$', check_text):
        return True  # 跳过数字后的逗号
    
    # Markdown标题保护
    if line_content.startswith('#'):
        return True
```

## 潜在问题排查

### 如果 Live2D 仍显示 iframe
1. 清除浏览器缓存
2. 检查 `desktop_pet.js` 确认使用的是新版 `initLive2D()`
3. 查看控制台是否有 PIXI 加载错误

### 如果文本仍然一次性显示
1. 检查 `audio` 消息处理是否移除了 `addMessage()` 调用
2. 检查 `AudioQueue.playNext()` 是否在播放前调用了 `addMessage()`

### 如果句子仍被错误切分
1. 检查后端是否已重启（修改Python文件需要重启）
2. 检查 `sentence_divider.py` 是否正确添加了 `should_skip_comma()`

## 总结

所有三个问题均已修复：
1. ✅ Live2D 使用 SDK 渲染（非iframe）
2. ✅ 文本随音频同步显示（队列机制）
3. ✅ 句子切割保护数字序号和Markdown标题

修改完成后需要：
- 重启后端服务器（Python代码修改）
- 重启桌面宠物应用（JavaScript代码修改）
