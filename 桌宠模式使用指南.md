# 灵犀助教 - 桌宠模式使用指南

## 🎉 已完成的新功能

### ✨ 全新桌宠模式界面
- **侧边布局**：Live2D 在左侧（300px），对话框在右侧（400px）
- **透明背景**：除人物和对话框外完全透明
- **漫画气泡**：助教回答以漫画风格气泡显示，带尖角指向 Live2D
- **Markdown + LaTeX**：完美支持格式化文本和数学公式渲染

### 🖱️ 交互方式

#### 1. 文本输入
- **鼠标悬停**：悬停对话区域自动显示输入框
- **快捷键**：`Ctrl + /` 唤起/隐藏输入框
- **发送**：`Ctrl + Enter` 或点击发送按钮

#### 2. 语音输入
- **自动监听**：启动后自动开启麦克风，使用 VAD 检测说话
- **状态指示**：底部显示"语音监听中..."绿色状态
- **禁用/启用**：右键菜单可切换麦克风状态

#### 3. Live2D 交互
- **左键点击**：打断当前回答
- **右键点击**：打开圆形径向菜单
- **拖拽窗口**：点击 Live2D 可拖动整个窗口

#### 4. 图片上传
- **拖拽上传**：直接拖拽图片到 Live2D 区域
- **菜单上传**：右键菜单选择"上传"按钮
- **自动分析**：上传后 AI 自动识别并讲解

### 🎯 圆形右键菜单

右键点击 Live2D 弹出径向菜单，5个按钮围绕中心排列：

```
      [麦克风]
         |
  [上传]--●--[历史]
         |
      [清空]
         |
      [设置]
```

- **🎤 麦克风**：禁用/启用语音监听
- **📜 历史**：查看历史对话记录
- **⚙️ 设置**：打开设置面板（自动滚动、Markdown、LaTeX）
- **🗑️ 清空**：清空当前对话
- **📷 上传**：选择图片上传

### ⌨️ 全局快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl + /` | 唤起/隐藏输入框 |
| `Ctrl + Enter` | 发送消息 |
| `Ctrl + Shift + L` | 切换桌宠/正常模式（原有功能） |
| `Ctrl + Shift + H` | 隐藏/显示窗口（原有功能） |
| `Ctrl + Shift + Q` | 退出应用（原有功能） |
| `ESC` | 关闭菜单和输入框 |

---

## 🚀 启动测试

### 1. 启动后端服务

```powershell
cd d:\Desktop\SoftwareDesign\Open-LLM-VTuber-v1.2.1-zh
uv run run_server.py
```

### 2. 启动桌面客户端

```powershell
cd desktop_launcher
npm start
```

或使用启动脚本：
```powershell
.\启动灵犀助教.ps1
```
选择 **选项 1 - 桌面客户端模式**

---

## 🧪 测试清单

### 基础功能测试

- [ ] **窗口显示**
  - [ ] 窗口大小为 700x600
  - [ ] 窗口位于屏幕右下角
  - [ ] 背景透明，只显示 Live2D 和对话框
  
- [ ] **WebSocket 连接**
  - [ ] 打开开发者工具，查看控制台
  - [ ] 应显示 "✅ WebSocket 连接成功"
  - [ ] 应显示 "✅ 桌宠模式初始化完成"

- [ ] **欢迎消息**
  - [ ] 启动时自动显示欢迎消息
  - [ ] 消息以蓝色漫画气泡显示
  - [ ] 气泡有尖角指向左侧

### 输入测试

- [ ] **文本输入**
  - [ ] 鼠标悬停对话区域，输入框自动显示
  - [ ] 输入 "你好"，点击发送
  - [ ] 用户消息显示为紫色气泡（右对齐）
  - [ ] 助教回答显示为白色气泡（左对齐）

- [ ] **快捷键**
  - [ ] 按 `Ctrl + /` 显示/隐藏输入框
  - [ ] 输入文字后按 `Ctrl + Enter` 发送

### Markdown 渲染测试

发送以下消息测试渲染：

```markdown
请用 Markdown 格式回答：

# 一级标题
## 二级标题
### 三级标题

**粗体文字** 和 *斜体文字*

- 列表项 1
- 列表项 2
  - 子列表

1. 有序列表 1
2. 有序列表 2

`代码片段` 和代码块：

​```python
def hello():
    print("Hello World")
​```

> 这是引用文字
```

预期：标题、加粗、列表、代码块都正确渲染

### LaTeX 公式测试

发送：
```
请写出二次方程求根公式和勾股定理
```

预期：
- 行内公式 $x = \frac{-b \pm \sqrt{b^2-4ac}}{2a}$ 正确渲染
- 独立公式 $$a^2 + b^2 = c^2$$ 居中显示

### 交互测试

- [ ] **左键点击 Live2D**
  - [ ] 发送打断信号
  - [ ] 控制台显示 "🛑 已发送打断信号"

- [ ] **右键点击 Live2D**
  - [ ] 弹出圆形菜单
  - [ ] 5个按钮围绕中心排列
  - [ ] 鼠标悬停按钮变大并变蓝
  - [ ] 点击任意按钮菜单消失

- [ ] **菜单功能**
  - [ ] 点击"麦克风"，状态变为红色"麦克风已禁用"
  - [ ] 再次点击恢复绿色"语音监听中..."
  - [ ] 点击"清空"，弹出确认对话框
  - [ ] 点击"设置"，弹出设置窗口
  - [ ] 点击"历史"，弹出历史窗口

### 图片上传测试

- [ ] **拖拽上传**
  - [ ] 拖拽图片到 Live2D 区域
  - [ ] 显示蓝色"拖放图片到这里"提示
  - [ ] 松开鼠标，图片上传
  - [ ] 显示 "📷 已上传 1 张图片"

- [ ] **菜单上传**
  - [ ] 右键菜单点击"上传"
  - [ ] 弹出文件选择框
  - [ ] 选择图片后上传

---

## 🐛 已知问题和待办

### 待实现功能

1. **Live2D 渲染**
   - 当前显示占位符"Live2D 加载中..."
   - 需要集成完整的 Live2D Cubism SDK
   - 需要加载模型文件（从 `../live2d-models/` 或 `../frontend/` 获取）

2. **历史对话加载**
   - 当前历史窗口显示"暂无历史记录"
   - 需要监听后端的 `fetch-history-list` 响应
   - 需要实现点击历史项加载对话的功能

3. **流式响应优化**
   - 当前支持 `full-text` 和 `text-stream`
   - 需要测试流式回答的渲染效果
   - 需要优化长文本的滚动体验

### 调试技巧

1. **查看控制台**
   - 已默认开启开发者工具
   - 查看 WebSocket 连接状态
   - 查看消息收发日志

2. **测试 WebSocket 消息**
   ```javascript
   // 在控制台执行
   AppState.ws.send(JSON.stringify({
       type: 'text-input',
       text: '你好'
   }));
   ```

3. **调试样式**
   - 使用开发者工具的元素检查器
   - 修改 `desktop_pet.css` 调整样式
   - 刷新页面查看效果（Ctrl+R）

---

## 📝 下一步优化建议

### 短期优化

1. **Live2D 集成**
   - 从原前端提取 Live2D 加载逻辑
   - 或使用 live2dcubismcore.js 直接初始化
   - 实现表情和口型同步

2. **语音功能完善**
   - 确认 VAD 自动检测是否正常工作
   - 添加音量可视化指示器
   - 实现语音转文本实时显示

3. **历史记录**
   - 实现历史对话列表加载
   - 添加搜索和过滤功能
   - 支持删除和导出历史

### 中期优化

1. **动画效果**
   - 消息出现的淡入动画 ✅
   - 菜单展开的旋转动画
   - Live2D 点击的反馈动画

2. **主题定制**
   - 支持切换对话框颜色主题
   - 支持自定义 Live2D 模型
   - 支持调整窗口透明度

3. **性能优化**
   - 长对话历史的虚拟滚动
   - Markdown 渲染缓存
   - 图片压缩和懒加载

---

## ✅ 成果总结

### 实现的核心功能

1. ✅ **完全独立的桌宠前端**
   - 不依赖原 React 前端
   - 完整的 WebSocket 通信
   - 独立的状态管理

2. ✅ **侧边布局设计**
   - Live2D 300px + 对话 400px
   - 透明背景
   - 漫画气泡风格

3. ✅ **完整的交互系统**
   - 文本输入（悬停+快捷键）
   - 语音监听（自动开启）
   - Live2D 交互（左键打断、右键菜单）
   - 图片上传（拖拽+菜单）

4. ✅ **圆形径向菜单**
   - 5个功能按钮
   - 优雅的动画效果
   - 现代化设计

5. ✅ **Markdown + LaTeX 渲染**
   - 完整的 Markdown 语法支持
   - KaTeX 公式渲染
   - 代码高亮
   - 表格和列表美化

### 技术亮点

- **纯原生 JavaScript**：无框架依赖，轻量高效
- **模块化设计**：HTML、CSS、JS 分离
- **事件驱动架构**：清晰的消息处理流程
- **响应式交互**：流畅的动画和反馈

---

**开发者**: GitHub Copilot  
**完成日期**: 2026年1月11日  
**版本**: v2.0.0 (桌宠模式重构版)
